{% extends "base.html" %}

{% block head %}
{{ super() }}
<script>filterableObjects = {{ api_keys | tojson }}</script>
<script src="/static/javascript/app/survey-builder/controllers/filterable-list-controller.js"></script>
<script src="/static/javascript/password_validation.js"></script>
<script>
      // provide the minimum password length for javascript password validation
      window.min_password_length = {{min_password_length}};

      function toggle_qr() {
        var x = document.getElementById("qr_code");
        if (x.style.display === "none") {
          x.style.display = "block";
        } else {
          x.style.display = "none";
      }
}

    </script>
{% endblock %}

{% block title %}Manage Credentials{% endblock %}

{% block content %}

{% if new_api_access_key %}
<div class="alert alert-warning">
  <p>Your new <b>API Access Key</b> is:
  <div class="container-fluid">
    <textarea
      rows="1"
      cols="100"
      readonly="readonly"
      aria-label="contains your newly generated API Access Key. Please record these somewhere; you will not be presented with the secret key again."
      onclick="this.focus();this.select()"
    >{{new_api_access_key}}</textarea></p>
  </div>
  <p>Your new <b>API Secret Key</b> is:
  <div class="container-fluid">
    <textarea
      rows="1"
      cols="100"
      readonly="readonly"
      aria-label="contains your newly generated API Secret Key. Please record these somewhere; you will not be presented with the secret key again."
      onclick="this.focus();this.select()"
    >{{new_api_secret_key}}</textarea></p>
  </div>
  Please record these somewhere; you will not be presented with the secret key again.
</div>
{% endif %}

<div class="container">
  <br>

  <div
    class="well col-xs-12 col-md-8 marg-r-n-0"
    style="height: 45em "
  >
    <h2 class="text-center"> Reset Your Password</h2>
    <p>Beiwe does not store your email address, and cannot get in contact with you. If you need your password reset you
      can contact your Beiwe study admin.
    <p><b>If you forget your password you will have to contact a Beiwe administrator to have it reset.</b>
      <b>Passwords require all of the following: </b>
    <ul class="list">
      <li
        class="list-item invalid"
        id="letter"
      >at least one lower case letter</li>
      <li
        class="list-item invalid"
        id="capital"
      >at least one upper case letter</li>
      <li
        class="list-item invalid"
        id="number"
      >at least one numeric character</li>
      <li
        class="list-item invalid"
        id="special"
      >at least one special character (! @ # $ % ^ [ ] etc.)</li>
      <li
        class="list-item invalid"
        id="length"
      >At least <b>{{min_password_length}}</b> characters (based on user type and authorized studies)</li>
      <li
        class="list-item invalid"
        id="match"
      >Confirmation must match password</li>
    </ul>
    <br>
    {% comment %} block enter from submitting form {% endcomment %}
    <form
      action="{{ easy_url('manage_researcher_endpoints.self_change_password') }}"
      method="post"
      class="form-horizontal"
      onkeydown="return event.key != 'Enter';"
    >
      <!-- Current password -->
      <div class="form-group">

        <label
          for="current_password"
          class="control-label col-xs-3"
          style="text-wrap: nowrap;"
        >Current Password:</label>
        <div class="col-xs-6">

          <input
            type="password"
            name="current_password"
            id="current_password"
            class="form-control"
            placeholder="Current Password"
          />
        </div>
      </div>

      <!-- New password -->
      <div class="form-group">

        <label
          for="new_password"
          class="control-label col-xs-3"
          style="text-wrap: nowrap;"
        >New Password:</label>
        <div class="col-xs-6">

          <input
            type="password"
            name="new_password"
            id="new_password"
            class="form-control"
            placeholder="New Password"
          />
        </div>
      </div>

      <!-- Confirm new password -->
      <div class="form-group">

        <label
          for="confirm_new_password"
          class="control-label col-xs-3 "
          style="text-wrap: nowrap;"
        >Confirm New Password:</label>
        <div class="col-xs-6">

          <input
            type="password"
            name="confirm_new_password"
            id="confirm_new_password"
            class="form-control"
            placeholder="Confirm New Password"
          />
        </div>
      </div>
      <br>

      <!-- Submit button -->
      <div class="form-group">
        <div class="col-xs-offset-3 col-xs-6">

          <button
            id="change_password_button"
            type="submit"
            class="btn btn-primary"
            disabled
          >Change Password</button>
        </div>
      </div>

    </form>
  </div>


  <div
    class="well col-xs-12 col-md-4 marg-l-1 marg-r"
    style="height: 45em; width: 32%;"
  >
    <h2 class="text-center"> Manage MFA </h2>
    <div
      class="text-center"
      style="font-style:italic;"
    >
      {% if researcher.requires_mfa %}
      You are authhorized on a study that requires MFA.
      {% else %}
      None of your authhorized studies require MFA.
      {% endif %}
    </div>
    <p>

      {% if has_mfa and not mfa_png %}
    <div
      class="text-center"
      style="font-style:italic;"
    >
      You have MFA configured, enter your password to view the QR code.
    </div>
    {% if display_bad_password %}
    <div
      class="text-center"
      style="font-style:normal;"
    >
      The password you entered was incorrect.
    </div>
    {% endif %}

    <form
      action="/manage_credentials"
      method="post"
    >
      <div class="form-group">

        <input
          type="password"
          name="view_mfa_password"
          id="view_mfa_password"
          class="form-control"
          placeholder="password required to view your MFA QR code"
          aria-label="enter your password if wish to display your MFA QR code"
        />
      </div>

      <button
        class="btn btn-warning pull-right marg-b-1"
        aria-label="click to reload the page with your MFA QR code visible"
      >View MFA QR Code</button>

    </form>
    {% endif %}

    {% if not has_mfa %}
    <div
      class="text-center"
      style="font-style:italic;"
    >
      You do not have MFA set up. To enable MFA enter your password below.
    </div>
    {% endif %}

    {% if mfa_png %}
    <div class="marg-b-1">
      <img
        class="text-center"
        id="qr_code"
        src="data:image/png;base64,{{mfa_png}}"
        alt="MFA QR Code"
        style="width:100%;"
        aria-label="this is your MFA QR code, scan it with your authenticator app"
      />

    </div>
    {% endif %}
    <p>

    <form
      action="/self_reset_mfa"
      method="post"
    >
      <div class="form-group">

        <input
          type="password"
          name="mfa_password"
          id="mfa_password"
          class="form-control"
          {% if has_mfa %}
          placeholder="password required to disable MFA"
          {% else %}
          placeholder="password required to enable MFA"
          {% endif %}
          aria-label="enter your password if you wish to create or destroy your MFA token"
        />
      </div>
      {% if has_mfa %}

      <input
        type="hidden"
        id="disable"
        name="disable"
        value="true"
      >

      <button
        class="btn btn-danger pull-right"
        onclick="return confirm('Are you sure you want to reset your MFA token?')"
        aria-label="click to clear your MFA token - you will be prompted to confirm this action"
      >
        Clear MFA Token
      </button>
      {% else %}

      <button class="btn btn-warning pull-right">Enable MFA</button>
      {% endif %}

    </form>
  </div>

  {# Test MFA Code #}
  {% if has_mfa %}
  <div class="well col-xs-12">
    <div class="col-xs-7 col-md-9 center-block">
      <h2>Test MFA Code</h2>
      You can test your MFA code hear without logging in and out.
      <p></p>
    </div>

    <form
      action="/test_mfa"
      method="post"
      class="form-horizontal"
    >
      <div class="form-group marg-t-2">
        <div class="col-xs-5 col-md-3">

          <input
            type="text"
            name="mfa_code"
            id="mfa_code"
            class="form-control-static text-center"
            placeholder="Six Digit Code"
            aria-label="enter your six digit MFA code to test if it is working"
          />

          <button
            class="btn btn-warning marg-l-1"
            aria-label="click to test the MFA code you entered"
          >Test My MFA Code</button>
        </div>
      </div>

    </form>
  </div>
  {% endif %}

  {# Data API credentials #}
  <div class="well col-xs-12">
    <div class="span-12">
      <h2>Manage API Credentials</h2>
    </div>

    <hr>
    <!-- Current credentials -->
    <div class="span-12">
      <h2>Existing API keys</h2>
    </div>

    <div
      id="filterableList"
      ng-controller="FilterableListController"
    >
      <div class="form-group col-xs-12">

        <input
          type="search"
          class="form-control"
          placeholder="Filter"
          ng-model="filterText"
          aria-label="search for the name of an api key that you created"
        >
      </div>
      <div class="table-responsive col-xs-12">
        <table class="table table-condensed table-striped">
          <thead>
            <tr>
              <th scope="col">Date Created</th>
              <th scope="col">Name</th>
              <th scope="col">Public Key</th>
              <th scope="col"></th>
            </tr>
          </thead>
          <tbody>
            <tr
              ng-repeat="apiKey in filterableObjects"
              ng-if="(apiKey.readable_name + apiKey.access_key_id + apiKey.created_on).toLowerCase().includes(filterText.toLowerCase())"
            >
              <td>
                <div class="marg-t-0-5"></div>{% raw %}{{ apiKey.created_on }}{% endraw %}
      </div>
      </td>
      <td>
        <div class="marg-t-0-5"></div>{% raw %}{{ apiKey.readable_name }}{% endraw %}
    </div>
    </td>
    <td>
      <div class="marg-t-0-5">{% raw %}{{ apiKey.access_key_id }}{% endraw %} </div>
    </td>
    <td>
      <form
        ng-if="apiKey.is_active"
        action="{{ url('manage_researcher_endpoints.self_disable_api_key') }}"
        method="post"
      >

        <input
          type="hidden"
          class="form-control"
          name="api_key_id"
          value="{% raw %}{{ apiKey.access_key_id }}{% endraw %}"
        />

        <button
          class="btn btn-sm btn-danger"
          onclick="return confirm('You are about to permanently disable this API Key, are you sure you want to do this?')"
          aria-label="click to permenantly delete this API key - you will be prompted to confirm this action"
        >Delete Key</button>

      </form>
      {# this is no longer visible because we are overwriting the deleted key... #}
      <div ng-if="!apiKey.is_active">Disabled</div>
    </td>
    </tr>
    <tbody />
    </table>
    <hr>
    <form
      action="{{ url('manage_researcher_endpoints.self_generate_api_key') }}"
      method="post"
      class="form-horizontal"
    >
      <div class="form-group col-md-10 col-xs-12">

        <label for="readable_name">Use a good, concise name for your credentials:</label>

        <input
          type="text"
          class="form-control"
          name="readable_name"
          id="readable_name"
          value=""
          aria-label="enter a name for your new API key, this will be used to identify it in the future"
        />
      </div>
      <div class="col-md-2 col-xs-12 marg-t-1-75 marg-b-1">

        <button
          class="btn btn-success"
          aria-label="click to generate a new API key"
        >Generate A New API Key</button>
      </div>

    </form>
  </div>
</div>
</div>
</div>
{% endblock %}