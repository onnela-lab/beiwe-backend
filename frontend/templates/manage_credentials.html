{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <script>filterableObjects = {{ api_keys | tojson }}</script>
    <!-- Sort first by activation, and next by access key alphabetically -->
    <script>
      filterableObjects.sort((function(a, b){
        if(a.access_key_id < b.access_key_id) { return -1; }
        if(a.access_key_id > b.access_key_id) { return 1; }
        return 0;}));
      filterableObjects.sort((function(a, b){
        if(a.is_active < b.is_active) { return 1; }
        if(a.is_active > b.is_active) { return -1; }
        return 0;}));
    </script>
    <script src="/static/javascript/app/survey-builder/controllers/filterable-list-controller.js"></script>
{% endblock %}

{% block title %}Manage Credentials{% endblock %}

{% block content %}
  <div class="container">
    <br>
    <div class="span-12">
      <h2>Reset Your Password</h2>

      <p><b>Don't forget your password!</b></p>
      <p>Beiwe does not store your email address, and has no other means of getting in contact with you.</p>
      <p><b>If you forget your password you will have to contact a Beiwe administrator to have it reset.</b></p>
      <p>The primary Beiwe administrator is Kenzie Carlson, she can be reached at <a href="mailto:kcarlson@hsph.harvard.edu"> kcarlson@hsph.harvard.edu</a>.</p>
    </div>

    <div class="well">
      <b>Passwords require all of the following:</b>
      <ul class="list">
        <li class="list-item">at least one lower case letter</li>
        <li class="list-item">at least one upper case letter</li>
        <li class="list-item">at least one numeric character</li>
        <li class="list-item">at least one special character (! @ # $ % ^ [ ] etc.)</li>
      </ul>
    </div>

    <form action="/reset_admin_password" method="post" class="form-horizontal">
      <!-- Current password -->
      <div class="form-group">
        <label for="current_password" class="control-label col-xs-3">Current Password:</label>
        <div class="col-xs-6">
          <input type="password" name="current_password" id="current_password" class="form-control" placeholder="Current Password"/>
        </div>
      </div>

      <!-- New password -->
      <div class="form-group">
        <label for="new_password" class="control-label col-xs-3">New Password:</label>
        <div class="col-xs-6">
          <input type="password" name="new_password" id="new_password" class="form-control" placeholder="New Password"/>
        </div>
      </div>

      <!-- Confirm new password -->
      <div class="form-group">
        <label for="confirm_new_password" class="control-label col-xs-3">Confirm New Password:</label>
        <div class="col-xs-6">
          <input type="password" name="confirm_new_password" id="confirm_new_password" class="form-control" placeholder="Confirm New Password"/>
        </div>
      </div>
      <br>

      <!-- Submit button -->
      <div class="form-group">
        <div class="col-xs-offset-3 col-xs-6">
          <button type="submit" class="btn btn-primary">Change Password</button>
        </div>
      </div>
    </form>

    <br><br><hr>

    <!-- new credentials -->
    <div class="well">
        <div class="span-12">
            <h2>New Credentials</h2>
        </div>
      <form action="/new_api_key" method="post" class="form-horizontal">
        <div class="form-group">
          <div class="form-group col-sm-12">
            <label for="readable_name">Choose a readable name for these credentials</label>
            <input type="text" class="form-control" name="readable_name" id="readable_name" value=""/>
          </div>
          <div class="form-check" style="display:none;">
            <input class="form-check-input" type="checkbox" value="" name="api_permission" id="api_permission" checked>
            <label class="form-check-label" for="api_permission">Enable Tableau API</label>
          </div>
          <div class="col-xs-offset-3 col-xs-6">
            <button type="submit" class="btn btn-primary" >Generate A New API Key</button>
          </div>
        </div>
      </form>
      <br>
    </div>
  </div>

  <!-- Current credentials -->
  <div class="span-12">
      <h2>Existing API keys</h2>
  </div>

  <div id="filterableList" ng-controller="FilterableListController" class="row">
    <div class="form-group col-sm-4">
      <input type="search" class="form-control" placeholder="Filter" ng-model="FilterText" autofocus>
    </div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Public Key</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="api_key in filterableObjects" ng-if="(api_key.readable_name + api_key.access_key_id).toLowerCase().includes(FilterText.toLowerCase()) || FilterText == null">
            <td>{% raw %}{{ api_key.readable_name }}{% endraw %}</td>
            <td>{% raw %}{{ api_key.access_key_id }}{% endraw %}</td>
            <td>
              <form ng-if="api_key.is_active" action="/disable_api_key" method="post">
                <div style="display:none;" class=form-group>
                  <input type="text" class="form-control" name="api_key_id" id="field_{% raw %}{{ api_key.access_key_id }}{% endraw %}" value="{% raw %}{{ api_key.access_key_id }}{% endraw %}"/>
                </div>
                <button type="submit" class="btn active btn-primary" onclick="return confirm('You are about to permanently disable this API Key for all users. Are you sure you want to do this?')">Disable Key</button>
              </form>
              <div ng-if="!api_key.is_active">Disabled</div>
            </td>
          </tr>
        <tbody/>
      </table>
    </div>
  </div>



{% endblock %}
