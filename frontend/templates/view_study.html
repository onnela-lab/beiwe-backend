{% extends "base.html" %}

{% block title %}View Study {{ study.name }}{% endblock %}

{% block head %}
{{ super() }}
<style> {% include LocalAssets.DATATABLES_CSS %} </style>
<script type="text/javascript">
    let studyId = "{{ study.id }}";
  </script>
<script type="text/javascript" charset="utf8" src="{{ ASSETS.DATATABLES }}"></script>
<script src="/static/javascript/participants_table.js" type="text/javascript"></script>
{% endblock %}

{% block content %}

<div
  class="container marg-l-n-1"
  style="max-width:1920px;"
>

  {% if site_admin or is_study_admin %}
  <div class="col-xs-8">
    <h2>{{ study.name }}</h2>
  </div>

  <div class="col-xs-4 h3-margins-vertical">
    <a
      href="/edit_study/{{ study['id'] }}"
      class="btn btn-success pull-right text-large"
    >
      Edit This Study
    </a>
  </div>

  {% else %}
  <div class="col-xs-9">
    <h2>{{ study.name }}</h2>
  </div>

  <div class="col-xs-3 marg-t-0-5">
    <a
      href="/dashboard/{{ study['id'] }}"
      class="btn btn-info h3-margins-vertical"
    >
      View the Study Dashboard
    </a>
  </div>
  {% endif %}

  <div>
    <h3 class="marg-t-1 marg-b-n-0-5 marg-l-0-5">
      Participants
    </h3>
    <span class="pull-right italic text-mono">
      Study ID: {{ study.object_id }}
    </span>
  </div>

  <div class="col-xs-12 well">
    <p>Total participants ever registered on this study:
      {{ "{:,}".format(participants_ever_registered_count) }}
    </p>

    <div class="x-scrollable">
      <table
        class="table table-striped table-hover"
        style=""
        id="participantList"
      >
        <thead>
          <tr>
            <th style="text-align: center; width: 80px;">Created</th>
            <th style="text-align: center; width: 80px; font-size: small">Initial Registration</th>
            <th style="width: 135px;">Patient ID</th>
            <th style="width: 140px;">Status</th>
            <th>Phone OS</th>
            {% if push_notifications_enabled %}
            {% for intervention in interventions | sort(case_sensitive=False) %}
            <th>{{ intervention }}</th>
            {% endfor %}
            {% endif %}
            {% for field in study_fields | sort(case_sensitive=False) %}
            <th>{{ field }}</th>
            {% endfor %}
          </tr>
        </thead>
    </div>
    </table>

    <form
      action={{ easy_url("manage_study_endpoints.download_participants_csv", study_id) }}
      method="post"
    >
      <div class="form-inline pull-left h3-margins marg-r-1">

        <input
          type="hidden"
          name="study_id"
          value="{{ study.id }}"
        >

        <button class="btn btn-primary">Download Participants Table</button>
      </div>

    </form>

    <form
      action="/create_new_participant"
      method="post"
    >
      <div class="pull-right h3-margins-vertical marg-l-1">

        <input
          type="hidden"
          name="study_id"
          value="{{ study.id }}"
        >

        <button class="btn btn-info">Add New <b>Participant</b></button>
      </div>

    </form>

    <button
      class="btn btn-success pull-right h3-margins-vertical"
      data-toggle="modal"
      data-target="#addManyPatientsModal"
      title="Enable a number of new participants to enroll in {{ study.name }}: 
              download a file of new Patient IDs and registration passwords"
    >Add <b>Many</b> New Participants</button>
    {% include 'create_many_participants_modal.html' %}
  </div>
  
  <hr>

  <div class="col-xs-11">
    <h3> Edit Surveys </h3>
  </div>
  
  <div class="col-xs-1">
    <a
      href="/create_survey/{{ study.id }}/tracking_survey"
      class="btn btn-info h3-margins pull-right marg-r-n-1"
    >
      Create New <b>Survey</b></a>
  </div>


  <div class="list-group well col-xs-12">
    {% if tracking_survey_info %}
    {% for info in tracking_survey_info %}

    <div>
      <a
        href="/edit_survey/{{study_id}}/{{info["id"] }}"
        class="list-group-item survey-button-margins"
      >

        <span class="col-xs-9">
          {% if info["name"].startswith("(Unnamed Survey") %}
          <span class="italic"> {{info["name"]}} </span>
          {% else %}
          <span class="bold"> {{info["name"]}} </span>
          {% endif %}
        </span>
        {# stick these metadata into a small table so we can stack them #}
        <table class="survey-inline-table pull-right">
          <div class="col-xs-3">
            <tr>
              <td>
                <span class="survey-micro-label"> Survey ID #{{info["object_id"]}} </span>
              </td>
            </tr>
            <tr>
              <td>
                <span class="survey-micro-label"> Updated: {{info["last_updated"]}} </span>
              </td>
            </tr>
          </div>
        </table>
      </a>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-xs-12 well text-center">
      This study does not have any Surveys.
    </div>
    {% endif %}
  </div>

  <div class="clearfix"></div>
  <hr>
  
  <div class="col-xs-11">
    <h3> Edit Audio Surveys </h3>
  </div>

  <div class="col-xs-1">
    <a
      href="/create_survey/{{ study.id }}/audio_survey"
      class="btn btn-info h3-margins pull-right marg-r-n-1"
    >
      Create New <b>Audio Survey</b></a>
  </div>


  <div class="list-group well col-xs-12">
    {% if audio_survey_info %}
    {% for info in audio_survey_info %}

    <div>
      <a
        href="/edit_survey/{{study_id}}/{{info["id"] }}"
        class="list-group-item survey-button-margins"
      >
        <span class="col-xs-9">
          {% if info["name"].startswith("(Unnamed Survey") %}
          <span class="italic"> {{info["name"]}} </span>
          {% else %}
          <span class="bold"> {{info["name"]}} </span>
          {% endif %}
        </span>

        {# stick these metadata into a small table so we can stack them #}
        <table class="survey-inline-table pull-right">
          <div class="col-xs-3">
            <tr>
              <td>
                <span class="survey-micro-label"> Survey ID #{{info["object_id"]}} </span>
              </td>
            </tr>
            <tr>
              <td>
                <span class="survey-micro-label"> Updated: {{info["last_updated"]}} </span>
              </td>
            </tr>
          </div>
        </table>
      </a>
    </div>
    {% endfor %}
    {% else %}
    <div class="col-xs-12 well text-center">
      This study does not have any Audio Surveys.
    </div>
    {% endif %}
  </div>
  
  <div class="clearfix"></div>
  <hr>
  
  <div>
    <h3>Study Configuration</h3>

    <div class="col-xs-12 well">
      {% if push_notifications_enabled %}
      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-success"
            href={{ easy_url("manage_study_endpoints.interventions_page", study_id=study.id) }}
          >
            Edit Interventions
          </a></p>
        Configure Interventions for use with Relative survey schedules
      </div>

      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-info"
            href={{ easy_url("manage_study_endpoints.download_study_interventions", study_id=study.id) }}
          >
            Download Interventions
          </a></p>
        Download the Intervention data for participants in your study.
      </div>
      {% endif %}

      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-success"
            href={{ easy_url('manage_study_endpoints.study_fields', study_id=study.id) }}
          >
            Edit Custom Fields
          </a></p>
        Edit custom tags for organizing participants in your study.
      </div>

      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-success"
            href={{ easy_url('study_endpoints.device_settings', study_id=study.id) }}
          >
            Edit App Settings
          </a></p>
        Configure types and quantity of the passive data streams this study collects, and the wording that study
        participants see in the app
      </div>

      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-info"
            href={{ easy_url('study_endpoints.export_study_settings_file', study_id=study.id) }}
          >
            Export Study Settings JSON
          </a></p>
        Download the full JSON configuration for this study.
      </div>

      <div class="col-xs-6 marg-b-2">
        <p><a
            class="btn btn-info"
            href={{ easy_url('manage_study_endpoints.download_study_survey_history', study_id=study.id) }}
          >
            Export Survey Edits History JSON
          </a></p>
        Download the JSON of every change made to surveys in this study.<i><br>(Includes current surveys.)</i>
      </div>
    </div>

  </div>

  {% if study.forest_enabled %}
  <div class="clearfix"></div>
  <hr>
  <div>
    <h3>Forest Data Analysis</h3>
    <div class="col-xs-12 well">

      {% if site_admin %}
      <div class="col-xs-6">
        <p><a
            class="btn btn-primary"
            href="{{ easy_url('forest_endpoints.create_tasks', study_id=study.id) }}"
          >
            Dispatch New Forest Tasks
          </a></p>
        Queue up new Forest analysis runs on participant data.
      </div>
      {% endif %}

      <div class="col-xs-6">
        <p><a
            class="btn btn-primary"
            href="{{ easy_url('forest_endpoints.task_log', study_id=study.id) }}"
          >
            View Forest Task History
          </a></p>
        View the runtime history of all Forest analysis tasks that have run on data from this study.
      </div>

    </div>
  </div>
  {% endif %}

</div>
</div>

{% endblock %}