<html>
<head>
  <meta charset="utf-8">
  <style> {% include LocalAssets.DARKLY %} </style>
  <style> {% include LocalAssets.ADMIN %} </style>
  <script> {% include LocalAssets.ANGULAR_APP_JS %} </script>
  <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.2/js.cookie.min.js" type="text/javascript"></script>
  <meta
    http-equiv="Cache-Control"
    content="no-store"
  />
  <script>
      (function () {
        var myConnector = tableau.makeConnector();
        myConnector.getSchema = function (schemaCallback) {

          var cols = {{ (cols|safe) }}

          var tableSchema = {
                id: "StudyData",
                alias: "Data from the Beiwe WDC on study with id: '{{ study_object_id }}'",
                columns: cols
            };
          schemaCallback([tableSchema]);
        };

        myConnector.getData = function (table, doneCallback) {
            $.ajax({
              dataType: "json",
              url: "{{ target_url }}" + tableau.connectionData,
              headers: {
                "X-Access-Key-Id": tableau.username,
                "X-Access-Key-Secret": tableau.password
              },
              error:
                function(response) {
                tableau.log(response); //the tableau log is accessible through the tableau WDC simulator for debugging
                tableau.abortWithError(response.responseText);
              },
              success:
                function(resp) {
                  table.appendRows(resp);
                  doneCallback();
                }});
        };
        tableau.registerConnector(myConnector);

        $(document).ready(function() {
            $("#submitButton").click(function() {
                tableau.username = document.getElementById('access_key_id').value
                tableau.password = document.getElementById('access_key_secret').value
                tableau.connectionName = "Study: {{ study_object_id }}"; // This will be the data source name in Tableau
                tableau.connectionData = window.location.search; //save the query string which contains parameters for the api call
                tableau.submit(); // This sends the connector object to Tableau
            });
          });
      })();
    </script>
  <head />
<body>
  <div class="container">
    <h1 class="text-center">Beiwe Study Web Data Connector</h1>
    <div class="text-center">For the study with ID: {{ study_object_id }}</div>
    <div class="form-group-lg">
      <div class="row vertical-center-row">
        <div class="text-center col-md-4 col-md-offset-4 mt-1 mb-1">

          <label hidden>Access Key Id:</label>

          <input
            id="access_key_id"
            type="text"
            class="form-control"
            placeholder="Access Key Id"
            aria-label="Enter access key id here"
          >
        </div>
      </div>
      <div class="row vertical-center-row">
        <div class="text-center col-md-4 col-md-offset-4 mb-1">

          <label hidden>Access Key Secret:</label>

          <input
            id="access_key_secret"
            type="password"
            class="form-control"
            placeholder="Access Key Secret"
            aria-label="enter secret key here"
          >
          <small
            id="helpBlock"
            class="form-text text-muted"
          >
            If you do not have not credentials, you can generate them <a class="bold"
              href="{{ easy_url('manage_researcher_endpoints.self_manage_credentials_page') }}"
            >here</a>
          </small>
        </div>
        

        <div class="col-md-4 col-md-offset-4">

          <button
            class="btn btn-primary"
            style="display: block; margin: 0 auto;"
            id="submitButton"
          >Get My Data</button>
        </div>

      </div>
    </div>
  </div>
</body>
</html>